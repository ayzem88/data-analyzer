# -*- coding: utf-8 -*-
"""
محلل الكلمات - تحليل الكلمات المفردة
يحفظ النتائج في ملفات txt
"""

import re
import os
from collections import Counter

class محلل_الكلمات:
    def __init__(self, مجلد_المدونة="المدونة", ملف_كلمات_الإيقاف="stop_words.txt"):
        self.مجلد_المدونة = مجلد_المدونة
        self.ملف_كلمات_الإيقاف = ملف_كلمات_الإيقاف
        self.مجلد_النتائج = "نتائج_التحليل"
        self.كلمات_الإيقاف = self.تحميل_كلمات_الإيقاف()
        
    def تحميل_كلمات_الإيقاف(self):
        """تحميل كلمات الإيقاف من الملف"""
        كلمات_الإيقاف = set()
        try:
            with open(self.ملف_كلمات_الإيقاف, 'r', encoding='utf-8') as ملف:
                for سطر in ملف:
                    كلمة = سطر.strip()
                    if كلمة:
                        كلمات_الإيقاف.add(كلمة)
        except FileNotFoundError:
            print(f"تحذير: ملف كلمات الإيقاف {self.ملف_كلمات_الإيقاف} غير موجود")
        return كلمات_الإيقاف
    
    def إزالة_التشكيل(self, كلمة):
        """إزالة التشكيل من كلمة واحدة"""
        تشكيل = re.compile(r'[\u064B-\u065F\u0617-\u061A]')
        return تشكيل.sub('', كلمة)
    
    def استخراج_الكلمات_العربية(self, نص):
        """استخراج الكلمات العربية فقط"""
        # نمط للكلمات العربية
        نمط_عربي = re.compile(r'[\u0600-\u06FF]+')
        كلمات = نمط_عربي.findall(نص)
        return كلمات
    
    def تصفية_الكلمات(self, كلمات):
        """تصفية الكلمات وإزالة كلمات الإيقاف والكلمات القصيرة"""
        كلمات_مُصفاة = []
        for كلمة in كلمات:
            كلمة_مُنظفة = self.إزالة_التشكيل(كلمة)
            # تجاهل الكلمات القصيرة جداً وكلمات الإيقاف
            if (len(كلمة_مُنظفة) > 1 and 
                كلمة_مُنظفة not in self.كلمات_الإيقاف):
                كلمات_مُصفاة.append(كلمة_مُنظفة)
        return كلمات_مُصفاة
    
    def تحليل_الكلمات_الكامل(self):
        """تحليل شامل للكلمات في جميع الملفات"""
        print("بدء تحليل الكلمات...")
        
        جميع_الكلمات = []
        إحصائيات_الملفات = []
        
        # قراءة جميع ملفات txt
        for اسم_ملف in os.listdir(self.مجلد_المدونة):
            if اسم_ملف.lower().endswith('.txt'):
                مسار_الملف = os.path.join(self.مجلد_المدونة, اسم_ملف)
                
                try:
                    # محاولة قراءة الملف بترميزات مختلفة
                    نص = ""
                    for ترميز in ['utf-8', 'cp1256', 'latin-1', 'iso-8859-1']:
                        try:
                            with open(مسار_الملف, 'r', encoding=ترميز) as ملف:
                                نص = ملف.read()
                            break
                        except UnicodeDecodeError:
                            continue
                    
                    if not نص:
                        print(f"تحذير: تعذر قراءة الملف {اسم_ملف}")
                        continue
                    
                    # استخراج وتصفية الكلمات
                    كلمات_خام = self.استخراج_الكلمات_العربية(نص)
                    كلمات_مُصفاة = self.تصفية_الكلمات(كلمات_خام)
                    
                    جميع_الكلمات.extend(كلمات_مُصفاة)
                    
                    إحصائيات_الملفات.append({
                        'اسم_الملف': اسم_ملف,
                        'عدد_الكلمات_الخام': len(كلمات_خام),
                        'عدد_الكلمات_المُصفاة': len(كلمات_مُصفاة)
                    })
                    
                except Exception as خطأ:
                    print(f"خطأ في قراءة الملف {اسم_ملف}: {خطأ}")
        
        # تحليل شامل
        self.تحليل_تكرار_الكلمات(جميع_الكلمات)
        self.تحليل_طول_الكلمات(جميع_الكلمات)
        self.إنشاء_إحصائيات_شاملة(جميع_الكلمات, إحصائيات_الملفات)
        
        print(f"تم تحليل {len(جميع_الكلمات)} كلمة من {len(إحصائيات_الملفات)} ملف")
    
    def تحليل_تكرار_الكلمات(self, كلمات):
        """تحليل تكرار الكلمات"""
        عداد_الكلمات = Counter(كلمات)
        
        # حفظ جميع الكلمات
        جميع_الكلمات_نص = '\n'.join(كلمات)
        self.حفظ_في_ملف("جميع_الكلمات", جميع_الكلمات_نص)
        
        # حفظ الكلمات الفريدة
        كلمات_فريدة = sorted(set(كلمات))
        كلمات_فريدة_نص = '\n'.join(كلمات_فريدة)
        self.حفظ_في_ملف("الكلمات_الفريدة", كلمات_فريدة_نص)
        
        # حفظ تكرار الكلمات
        تكرار_الكلمات_نص = ""
        for كلمة, تكرار in عداد_الكلمات.most_common():
            تكرار_الكلمات_نص += f"{كلمة}: {تكرار}\n"
        self.حفظ_في_ملف("تكرار_الكلمات", تكرار_الكلمات_نص)
    
    def تحليل_طول_الكلمات(self, كلمات):
        """تحليل طول الكلمات"""
        كلمات_فريدة = set(كلمات)
        أطوال_الكلمات = {}
        
        for كلمة in كلمات_فريدة:
            طول = len(كلمة)
            if طول not in أطوال_الكلمات:
                أطوال_الكلمات[طول] = []
            أطوال_الكلمات[طول].append(كلمة)
        
        # حفظ طول الكلمات
        طول_الكلمات_نص = ""
        for طول in sorted(أطوال_الكلمات.keys(), reverse=True):
            for كلمة in أطوال_الكلمات[طول]:
                طول_الكلمات_نص += f"{كلمة}: {طول}\n"
        self.حفظ_في_ملف("طول_الكلمات", طول_الكلمات_نص)
    
    def إنشاء_إحصائيات_شاملة(self, كلمات, إحصائيات_الملفات):
        """إنشاء إحصائيات شاملة للكلمات"""
        عداد_الكلمات = Counter(كلمات)
        كلمات_فريدة = set(كلمات)
        
        # حساب الإحصائيات
        إجمالي_الكلمات = len(كلمات)
        عدد_الكلمات_الفريدة = len(كلمات_فريدة)
        أكثر_كلمة_تكراراً = عداد_الكلمات.most_common(1)[0] if عداد_الكلمات else ("", 0)
        
        # حساب متوسط طول الكلمات
        أطوال = [len(كلمة) for كلمة in كلمات]
        متوسط_الطول = sum(أطوال) / len(أطوال) if أطوال else 0
        
        # حساب توزيع الأطوال
        توزيع_الأطوال = Counter(أطوال)
        
        # إنشاء التقرير
        تقرير = f"""=== إحصائيات الكلمات الشاملة ===

إحصائيات عامة:
- إجمالي عدد الكلمات: {إجمالي_الكلمات:,}
- عدد الكلمات الفريدة: {عدد_الكلمات_الفريدة:,}
- أكثر كلمة تكراراً: {أكثر_كلمة_تكراراً[0]} ({أكثر_كلمة_تكراراً[1]} مرة)
- متوسط طول الكلمات: {متوسط_الطول:.2f} حرف

أكثر 20 كلمة تكراراً:
"""
        
        for مرتبة, (كلمة, تكرار) in enumerate(عداد_الكلمات.most_common(20), 1):
            تقرير += f"{مرتبة}. {كلمة}: {تكرار}\n"
        
        تقرير += "\nتوزيع أطوال الكلمات:\n"
        for طول in sorted(توزيع_الأطوال.keys()):
            عدد = توزيع_الأطوال[طول]
            نسبة = (عدد / إجمالي_الكلمات) * 100
            تقرير += f"طول {طول} حروف: {عدد:,} كلمة ({نسبة:.1f}%)\n"
        
        تقرير += "\nإحصائيات الملفات:\n"
        for ملف in إحصائيات_الملفات:
            تقرير += f"- {ملف['اسم_الملف']}: {ملف['عدد_الكلمات_المُصفاة']} كلمة\n"
        
        self.حفظ_في_ملف("إحصائيات_الكلمات", تقرير)
    
    def حفظ_في_ملف(self, اسم_الملف, محتوى):
        """حفظ المحتوى في ملف txt"""
        if not os.path.exists(self.مجلد_النتائج):
            os.makedirs(self.مجلد_النتائج)
        
        مسار_الملف = os.path.join(self.مجلد_النتائج, f"{اسم_الملف}.txt")
        with open(مسار_الملف, 'w', encoding='utf-8') as ملف:
            ملف.write(محتوى)
        print(f"تم حفظ: {مسار_الملف}")
