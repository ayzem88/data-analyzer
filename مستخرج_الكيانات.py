# -*- coding: utf-8 -*-
"""
مستخرج الكيانات المسماة - استخراج الأسماء والأعلام والدول والمدن
يحفظ النتائج في ملفات txt
"""

import re
import os
from collections import Counter

class مستخرج_الكيانات:
    def __init__(self, مجلد_المدونة="المدونة"):
        self.مجلد_المدونة = مجلد_المدونة
        self.مجلد_النتائج = "نتائج_التحليل"
        self.قواعد_البيانات = self.تحميل_قواعد_البيانات()
        
    def تحميل_قواعد_البيانات(self):
        """تحميل قواعد البيانات للأسماء والدول والمنظمات"""
        قواعد_البيانات = {
            'أسماء': set(),
            'دول_ومدن': set(),
            'منظمات_ومؤسسات': set()
        }
        
        # تحميل الأسماء
        try:
            with open('الأعلام والشخصيات.txt', 'r', encoding='utf-8') as ملف:
                for سطر in ملف:
                    اسم = سطر.strip()
                    if اسم:
                        قواعد_البيانات['أسماء'].add(اسم)
        except FileNotFoundError:
            print("تحذير: ملف الأعلام والشخصيات غير موجود")
        
        # تحميل الدول والمدن
        try:
            with open('الدول والمدن.txt', 'r', encoding='utf-8') as ملف:
                for سطر in ملف:
                    مكان = سطر.strip()
                    if مكان:
                        قواعد_البيانات['دول_ومدن'].add(مكان)
        except FileNotFoundError:
            print("تحذير: ملف الدول والمدن غير موجود")
        
        # تحميل المنظمات والمؤسسات
        try:
            with open('المنظمات والمؤسسات.txt', 'r', encoding='utf-8') as ملف:
                for سطر in ملف:
                    منظمة = سطر.strip()
                    if منظمة:
                        قواعد_البيانات['منظمات_ومؤسسات'].add(منظمة)
        except FileNotFoundError:
            print("تحذير: ملف المنظمات والمؤسسات غير موجود")
        
        return قواعد_البيانات
    
    def إزالة_التشكيل(self, نص):
        """إزالة التشكيل من النص"""
        تشكيل = re.compile(r'[\u064B-\u065F\u0617-\u061A]')
        return تشكيل.sub('', نص)
    
    def استخراج_الكلمات_العربية(self, نص):
        """استخراج الكلمات العربية فقط"""
        نمط_عربي = re.compile(r'[\u0600-\u06FF]+')
        كلمات = نمط_عربي.findall(نص)
        return كلمات
    
    def استخراج_الأسماء_والأعلام(self, كلمات):
        """استخراج الأسماء والأعلام من الكلمات"""
        أسماء_مستخرجة = []
        
        # البحث في قاعدة البيانات فقط - لا نستخرج كلمات عادية
        for كلمة in كلمات:
            كلمة_مُنظفة = self.إزالة_التشكيل(كلمة)
            
            # البحث في قاعدة البيانات فقط - استبعاد الكلمات العامة
            كلمات_مستبعدة = [
                'على', 'ولا', 'عند', 'يكن', 'ليس', 'كثير', 'جميع', 'لما', 'هنا', 'وجود', 'علم', 'كتاب', 'سبيل', 'فكرة', 'تاريخ', 'نفس', 'كيف', 'كبير', 'أكبر', 'لكن', 'مدينة', 'ملك', 'مجموعة', 'لكي', 'علي', 'فهم', 'بحر', 'علوم', 'نهاية', 'عبد', 'باشا', 'حق', 'عهد', 'بشري', 'باسم', 'داخل', 'معنى', 'معينة', 'أفضل', 'رئيس', 'قانون', 'جنوب', 'أعضاء', 'عشرة', 'لغة', 'شكل', 'فعل', 'مدى', 'صاحب', 'طبيعة', 'قدر', 'يزيد', 'شعر', 'شمال', 'شديد', 'رب', 'كتب', 'بلاد', 'جنوب', 'قومية', 'دولة',
                'الناس', 'عليه', 'العالم', 'الله', 'الحياة', 'منه', 'العلم', 'العمل', 'العقل', 'العرب', 'الملك', 'الدولة', 'عالم', 'الدين', 'نظام', 'حياة', 'النفس', 'الفكر', 'الحكم', 'البحر', 'العلوم', 'الحق', 'البشري', 'العربية', 'القانون', 'اللغة', 'الإسلام', 'العلمي', 'الاجتماعية', 'الشمال', 'العالمية', 'الرب', 'الكتب', 'الجنوب', 'القومية'
            ]
            
            if (كلمة_مُنظفة in self.قواعد_البيانات['أسماء'] and 
                len(كلمة_مُنظفة) >= 2 and
                كلمة_مُنظفة not in كلمات_مستبعدة):
                أسماء_مستخرجة.append(كلمة_مُنظفة)
        
        return أسماء_مستخرجة
    
    def استخراج_الدول_والمدن(self, كلمات):
        """استخراج الدول والمدن من الكلمات"""
        أماكن_مستخرجة = []
        
        for كلمة in كلمات:
            كلمة_مُنظفة = self.إزالة_التشكيل(كلمة)
            
            # البحث في قاعدة البيانات فقط (بدون أنماط إضافية)
            if كلمة_مُنظفة in self.قواعد_البيانات['دول_ومدن']:
                أماكن_مستخرجة.append(كلمة_مُنظفة)
        
        return أماكن_مستخرجة
    
    def استخراج_المؤسسات_والمنظمات(self, كلمات):
        """استخراج المؤسسات والمنظمات"""
        مؤسسات_مستخرجة = []
        
        # البحث في قاعدة البيانات
        for كلمة in كلمات:
            كلمة_مُنظفة = self.إزالة_التشكيل(كلمة)
            if كلمة_مُنظفة in self.قواعد_البيانات['منظمات_ومؤسسات']:
                مؤسسات_مستخرجة.append(كلمة_مُنظفة)
        
        # البحث عن أنماط المؤسسات في النص الكامل
        نص_كامل = ' '.join(كلمات)
        أنماط_مؤسسات = [
            r'جامعة\s+[\u0600-\u06FF]+',
            r'مدرسة\s+[\u0600-\u06FF]+',
            r'مكتبة\s+[\u0600-\u06FF]+',
            r'مستشفى\s+[\u0600-\u06FF]+',
            r'بنك\s+[\u0600-\u06FF]+',
            r'شركة\s+[\u0600-\u06FF]+',
            r'وزارة\s+[\u0600-\u06FF]+',
            r'هيئة\s+[\u0600-\u06FF]+',
            r'مجلس\s+[\u0600-\u06FF]+',
            r'جمعية\s+[\u0600-\u06FF]+'
        ]
        
        for نمط in أنماط_مؤسسات:
            تطابقات = re.findall(نمط, نص_كامل)
            مؤسسات_مستخرجة.extend(تطابقات)
        
        return مؤسسات_مستخرجة
    
    def استخراج_التواريخ_والأماكن(self, كلمات):
        """استخراج التواريخ والأماكن"""
        تواريخ_وأماكن = []
        
        # البحث عن أنماط التواريخ
        أنماط_تواريخ = [
            r'\d{4}',
            r'\d{1,2}/\d{1,2}/\d{4}',
            r'\d{1,2}-\d{1,2}-\d{4}'
        ]
        
        نص_كامل = ' '.join(كلمات)
        for نمط in أنماط_تواريخ:
            تطابقات = re.findall(نمط, نص_كامل)
            تواريخ_وأماكن.extend(تطابقات)
        
        return تواريخ_وأماكن
    
    def استخراج_جميع_الكيانات(self):
        """استخراج جميع الكيانات من جميع الملفات"""
        print("بدء استخراج الكيانات المسماة...")
        
        جميع_الأسماء = []
        جميع_الأماكن = []
        جميع_المؤسسات = []
        جميع_التواريخ = []
        
        # قراءة جميع ملفات txt
        for اسم_ملف in os.listdir(self.مجلد_المدونة):
            if اسم_ملف.lower().endswith('.txt'):
                مسار_الملف = os.path.join(self.مجلد_المدونة, اسم_ملف)
                
                try:
                    # محاولة قراءة الملف بترميزات مختلفة
                    نص = ""
                    for ترميز in ['utf-8', 'cp1256', 'latin-1', 'iso-8859-1']:
                        try:
                            with open(مسار_الملف, 'r', encoding=ترميز) as ملف:
                                نص = ملف.read()
                            break
                        except UnicodeDecodeError:
                            continue
                    
                    if not نص:
                        print(f"تحذير: تعذر قراءة الملف {اسم_ملف}")
                        continue
                    
                    # استخراج الكلمات
                    كلمات = self.استخراج_الكلمات_العربية(نص)
                    
                    # استخراج الكيانات - البحث في قاعدة البيانات فقط
                    أسماء = self.استخراج_الأسماء_والأعلام(كلمات)
                    أماكن = self.استخراج_الدول_والمدن(كلمات)
                    مؤسسات = self.استخراج_المؤسسات_والمنظمات(كلمات)
                    تواريخ = self.استخراج_التواريخ_والأماكن(كلمات)
                    
                    جميع_الأسماء.extend(أسماء)
                    جميع_الأماكن.extend(أماكن)
                    جميع_المؤسسات.extend(مؤسسات)
                    جميع_التواريخ.extend(تواريخ)
                    
                except Exception as خطأ:
                    print(f"خطأ في قراءة الملف {اسم_ملف}: {خطأ}")
        
        # حفظ النتائج
        self.حفظ_الأسماء_والأعلام(جميع_الأسماء)
        self.حفظ_الدول_والمدن(جميع_الأماكن)
        self.حفظ_المؤسسات_والمنظمات(جميع_المؤسسات)
        self.حفظ_التواريخ_والأماكن(جميع_التواريخ)
        
        print(f"تم استخراج {len(جميع_الأسماء)} اسم، {len(جميع_الأماكن)} مكان، {len(جميع_المؤسسات)} مؤسسة، {len(جميع_التواريخ)} تاريخ")
    
    def حفظ_الأسماء_والأعلام(self, أسماء):
        """حفظ الأسماء والأعلام"""
        عداد_الأسماء = Counter(أسماء)
        
        نص_الأسماء = "=== الأسماء والأعلام المستخرجة ===\n\n"
        نص_الأسماء += "الاسم | التكرار\n"
        نص_الأسماء += "-" * 30 + "\n"
        
        for اسم, تكرار in عداد_الأسماء.most_common():
            نص_الأسماء += f"{اسم}: {تكرار}\n"
        
        self.حفظ_في_ملف("الأسماء_والأعلام", نص_الأسماء)
    
    def حفظ_الدول_والمدن(self, أماكن):
        """حفظ الدول والمدن"""
        عداد_الأماكن = Counter(أماكن)
        
        نص_الأماكن = "=== الدول والمدن المستخرجة ===\n\n"
        نص_الأماكن += "المكان | التكرار\n"
        نص_الأماكن += "-" * 30 + "\n"
        
        for مكان, تكرار in عداد_الأماكن.most_common():
            نص_الأماكن += f"{مكان}: {تكرار}\n"
        
        self.حفظ_في_ملف("الدول_والمدن", نص_الأماكن)
    
    def حفظ_المؤسسات_والمنظمات(self, مؤسسات):
        """حفظ المؤسسات والمنظمات"""
        عداد_المؤسسات = Counter(مؤسسات)
        
        نص_المؤسسات = "=== المؤسسات والمنظمات المستخرجة ===\n\n"
        نص_المؤسسات += "المؤسسة | التكرار\n"
        نص_المؤسسات += "-" * 40 + "\n"
        
        for مؤسسة, تكرار in عداد_المؤسسات.most_common():
            نص_المؤسسات += f"{مؤسسة}: {تكرار}\n"
        
        self.حفظ_في_ملف("المؤسسات_والمنظمات", نص_المؤسسات)
    
    def حفظ_التواريخ_والأماكن(self, تواريخ):
        """حفظ التواريخ والأماكن"""
        عداد_التواريخ = Counter(تواريخ)
        
        نص_التواريخ = "=== التواريخ والأماكن المستخرجة ===\n\n"
        نص_التواريخ += "التاريخ/المكان | التكرار\n"
        نص_التواريخ += "-" * 40 + "\n"
        
        for تاريخ, تكرار in عداد_التواريخ.most_common():
            نص_التواريخ += f"{تاريخ}: {تكرار}\n"
        
        self.حفظ_في_ملف("التواريخ_والأماكن", نص_التواريخ)
    
    def حفظ_في_ملف(self, اسم_الملف, محتوى):
        """حفظ المحتوى في ملف txt"""
        if not os.path.exists(self.مجلد_النتائج):
            os.makedirs(self.مجلد_النتائج)
        
        مسار_الملف = os.path.join(self.مجلد_النتائج, f"{اسم_الملف}.txt")
        with open(مسار_الملف, 'w', encoding='utf-8') as ملف:
            ملف.write(محتوى)
        print(f"تم حفظ: {مسار_الملف}")
