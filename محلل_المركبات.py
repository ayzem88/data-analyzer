# -*- coding: utf-8 -*-
"""
محلل المركبات - تحليل المركبات الثنائية والثلاثية مع المختار التركيبي
يحفظ النتائج في ملفات txt
"""

import re
import os
import math
from collections import Counter, defaultdict

class محلل_المركبات:
    def __init__(self, مجلد_المدونة="المدونة", ملف_كلمات_الإيقاف="stop_words.txt"):
        self.مجلد_المدونة = مجلد_المدونة
        self.ملف_كلمات_الإيقاف = ملف_كلمات_الإيقاف
        self.مجلد_النتائج = "نتائج_التحليل"
        self.كلمات_الإيقاف = self.تحميل_كلمات_الإيقاف()
        
    def تحميل_كلمات_الإيقاف(self):
        """تحميل كلمات الإيقاف من الملف"""
        كلمات_الإيقاف = set()
        try:
            with open(self.ملف_كلمات_الإيقاف, 'r', encoding='utf-8') as ملف:
                for سطر in ملف:
                    كلمة = سطر.strip()
                    if كلمة:
                        كلمات_الإيقاف.add(كلمة)
        except FileNotFoundError:
            print(f"تحذير: ملف كلمات الإيقاف {self.ملف_كلمات_الإيقاف} غير موجود")
        return كلمات_الإيقاف
    
    def إزالة_التشكيل(self, كلمة):
        """إزالة التشكيل من كلمة واحدة"""
        تشكيل = re.compile(r'[\u064B-\u065F\u0617-\u061A]')
        return تشكيل.sub('', كلمة)
    
    def استخراج_الكلمات_العربية(self, نص):
        """استخراج الكلمات العربية فقط"""
        نمط_عربي = re.compile(r'[\u0600-\u06FF]+')
        كلمات = نمط_عربي.findall(نص)
        return كلمات
    
    def تصفية_الكلمات(self, كلمات):
        """تصفية الكلمات وإزالة كلمات الإيقاف والكلمات القصيرة"""
        كلمات_مُصفاة = []
        for كلمة in كلمات:
            كلمة_مُنظفة = self.إزالة_التشكيل(كلمة)
            if (len(كلمة_مُنظفة) > 1 and 
                كلمة_مُنظفة not in self.كلمات_الإيقاف):
                كلمات_مُصفاة.append(كلمة_مُنظفة)
        return كلمات_مُصفاة
    
    def استخراج_المركبات(self, كلمات):
        """استخراج المركبات الثنائية والثلاثية"""
        مركبات_ثنائية = []
        مركبات_ثلاثية = []
        
        # استخراج المركبات الثنائية
        for i in range(len(كلمات) - 1):
            مركبات_ثنائية.append((كلمات[i], كلمات[i+1]))
        
        # استخراج المركبات الثلاثية
        for i in range(len(كلمات) - 2):
            مركبات_ثلاثية.append((كلمات[i], كلمات[i+1], كلمات[i+2]))
        
        return مركبات_ثنائية, مركبات_ثلاثية
    
    def تحليل_المركبات_الكامل(self):
        """تحليل شامل للمركبات في جميع الملفات"""
        print("بدء تحليل المركبات...")
        
        جميع_الكلمات = []
        جميع_المركبات_الثنائية = []
        جميع_المركبات_الثلاثية = []
        
        # قراءة جميع ملفات txt
        for اسم_ملف in os.listdir(self.مجلد_المدونة):
            if اسم_ملف.lower().endswith('.txt'):
                مسار_الملف = os.path.join(self.مجلد_المدونة, اسم_ملف)
                
                try:
                    # محاولة قراءة الملف بترميزات مختلفة
                    نص = ""
                    for ترميز in ['utf-8', 'cp1256', 'latin-1', 'iso-8859-1']:
                        try:
                            with open(مسار_الملف, 'r', encoding=ترميز) as ملف:
                                نص = ملف.read()
                            break
                        except UnicodeDecodeError:
                            continue
                    
                    if not نص:
                        print(f"تحذير: تعذر قراءة الملف {اسم_ملف}")
                        continue
                    
                    # استخراج وتصفية الكلمات
                    كلمات_خام = self.استخراج_الكلمات_العربية(نص)
                    كلمات_مُصفاة = self.تصفية_الكلمات(كلمات_خام)
                    
                    جميع_الكلمات.extend(كلمات_مُصفاة)
                    
                    # استخراج المركبات
                    مركبات_ثنائية, مركبات_ثلاثية = self.استخراج_المركبات(كلمات_مُصفاة)
                    جميع_المركبات_الثنائية.extend(مركبات_ثنائية)
                    جميع_المركبات_الثلاثية.extend(مركبات_ثلاثية)
                    
                except Exception as خطأ:
                    print(f"خطأ في قراءة الملف {اسم_ملف}: {خطأ}")
        
        # تحليل المركبات
        self.تحليل_المركبات_الثنائية(جميع_المركبات_الثنائية)
        self.تحليل_المركبات_الثلاثية(جميع_المركبات_الثلاثية)
        self.تحليل_المختار_التركيبي(جميع_المركبات_الثنائية, جميع_الكلمات)
        
        print(f"تم تحليل {len(جميع_المركبات_الثنائية)} مركب ثنائي و {len(جميع_المركبات_الثلاثية)} مركب ثلاثي")
    
    def تحليل_المركبات_الثنائية(self, مركبات_ثنائية):
        """تحليل المركبات الثنائية"""
        عداد_المركبات = Counter(مركبات_ثنائية)
        
        # حفظ جميع المركبات الثنائية
        جميع_المركبات_نص = ""
        for مركب in مركبات_ثنائية:
            جميع_المركبات_نص += f"{مركب[0]} {مركب[1]}\n"
        self.حفظ_في_ملف("المركبات_الثنائية", جميع_المركبات_نص)
        
        # حفظ المركبات الثنائية الفريدة
        مركبات_فريدة = sorted(set(مركبات_ثنائية))
        مركبات_فريدة_نص = ""
        for مركب in مركبات_فريدة:
            مركبات_فريدة_نص += f"{مركب[0]} {مركب[1]}\n"
        self.حفظ_في_ملف("المركبات_الثنائية_الفريدة", مركبات_فريدة_نص)
        
        # حفظ تكرار المركبات الثنائية
        تكرار_المركبات_نص = ""
        for مركب, تكرار in عداد_المركبات.most_common():
            تكرار_المركبات_نص += f"{مركب[0]} {مركب[1]}: {تكرار}\n"
        self.حفظ_في_ملف("تكرار_المركبات_الثنائية", تكرار_المركبات_نص)
    
    def تحليل_المركبات_الثلاثية(self, مركبات_ثلاثية):
        """تحليل المركبات الثلاثية"""
        عداد_المركبات = Counter(مركبات_ثلاثية)
        
        # حفظ جميع المركبات الثلاثية
        جميع_المركبات_نص = ""
        for مركب in مركبات_ثلاثية:
            جميع_المركبات_نص += f"{مركب[0]} {مركب[1]} {مركب[2]}\n"
        self.حفظ_في_ملف("المركبات_الثلاثية", جميع_المركبات_نص)
        
        # حفظ المركبات الثلاثية الفريدة
        مركبات_فريدة = sorted(set(مركبات_ثلاثية))
        مركبات_فريدة_نص = ""
        for مركب in مركبات_فريدة:
            مركبات_فريدة_نص += f"{مركب[0]} {مركب[1]} {مركب[2]}\n"
        self.حفظ_في_ملف("المركبات_الثلاثية_الفريدة", مركبات_فريدة_نص)
        
        # حفظ تكرار المركبات الثلاثية
        تكرار_المركبات_نص = ""
        for مركب, تكرار in عداد_المركبات.most_common():
            تكرار_المركبات_نص += f"{مركب[0]} {مركب[1]} {مركب[2]}: {تكرار}\n"
        self.حفظ_في_ملف("تكرار_المركبات_الثلاثية", تكرار_المركبات_نص)
    
    def حساب_المقاييس_الإحصائية(self, f12, f1, f2, N):
        """حساب المقاييس الإحصائية للمركبات"""
        # PMI (Pointwise Mutual Information)
        pmi = math.log2((f12/N)/((f1/N)*(f2/N))) if f1 and f2 else 0
        
        # T-score
        exp = (f1 * f2) / N
        t_score = (f12 - exp) / math.sqrt(f12) if f12 else 0
        
        # Log-likelihood
        k11 = f12
        k12 = f1 - f12
        k21 = f2 - f12
        k22 = N - (f1 + f2 - f12)
        
        def term(k, m):
            return k * math.log(k / m) if k and m else 0
        
        row1, row2 = k11 + k12, k21 + k22
        col1, col2 = k11 + k21, k12 + k22
        m11 = row1 * col1 / N
        m12 = row1 * col2 / N
        m21 = row2 * col1 / N
        m22 = row2 * col2 / N
        
        ll = 2 * sum(term(k, m) for k, m in ((k11, m11), (k12, m12), (k21, m21), (k22, m22)))
        
        return pmi, t_score, ll
    
    def تصنيف_المركب(self, pmi, t_score, ll):
        """تصنيف قوة المركب بناءً على المقاييس"""
        if pmi >= 7 and t_score >= 5 and ll >= 150:
            return "ترجيح قوي جداً"
        elif pmi >= 6 and t_score >= 4 and ll >= 100:
            return "ترجيح قوي"
        elif pmi >= 5 and t_score >= 3.5 and ll >= 70:
            return "ترجيح محتمل جداً"
        elif pmi >= 4 and t_score >= 3 and ll >= 50:
            return "ترجيح محتمل"
        elif pmi >= 3 and t_score >= 2.5 and ll >= 20:
            return "تركيب ضعيف"
        else:
            return "تركيب ضعيف جداً"
    
    def تحليل_المختار_التركيبي(self, مركبات_ثنائية, كلمات):
        """تحليل المختار التركيبي للمركبات"""
        print("بدء تحليل المختار التركيبي...")
        
        # حساب التكرارات
        عداد_المركبات = Counter(مركبات_ثنائية)
        عداد_الكلمات = Counter(كلمات)
        
        N = len(مركبات_ثنائية)  # إجمالي عدد المركبات
        مركبات_مختارة = []
        
        # تحليل كل مركب
        for مركب, تكرار_المركب in عداد_المركبات.items():
            كلمة1, كلمة2 = مركب
            تكرار_كلمة1 = عداد_الكلمات[كلمة1]
            تكرار_كلمة2 = عداد_الكلمات[كلمة2]
            
            # حساب المقاييس
            pmi, t_score, ll = self.حساب_المقاييس_الإحصائية(
                تكرار_المركب, تكرار_كلمة1, تكرار_كلمة2, N
            )
            
            # تصنيف المركب
            تصنيف = self.تصنيف_المركب(pmi, t_score, ll)
            
            # حفظ المركبات المهمة فقط
            if pmi >= 3 and t_score >= 2 and ll >= 10:
                مركبات_مختارة.append({
                    'مركب': f"{كلمة1} {كلمة2}",
                    'تكرار': تكرار_المركب,
                    'تكرار_كلمة1': تكرار_كلمة1,
                    'تكرار_كلمة2': تكرار_كلمة2,
                    'pmi': round(pmi, 3),
                    't_score': round(t_score, 3),
                    'log_likelihood': round(ll, 3),
                    'تصنيف': تصنيف
                })
        
        # ترتيب المركبات حسب PMI
        مركبات_مختارة.sort(key=lambda x: x['pmi'], reverse=True)
        
        # حفظ النتائج
        مركبات_مختارة_نص = "=== المركبات المختارة تركيبياً ===\n\n"
        مركبات_مختارة_نص += "المركب | التكرار | تكرار الكلمة1 | تكرار الكلمة2 | PMI | T-score | Log-likelihood | التصنيف\n"
        مركبات_مختارة_نص += "-" * 120 + "\n"
        
        for مركب in مركبات_مختارة:
            مركبات_مختارة_نص += f"{مركب['مركب']} | {مركب['تكرار']} | {مركب['تكرار_كلمة1']} | {مركب['تكرار_كلمة2']} | {مركب['pmi']} | {مركب['t_score']} | {مركب['log_likelihood']} | {مركب['تصنيف']}\n"
        
        self.حفظ_في_ملف("المركبات_المختارة_تركيبياً", مركبات_مختارة_نص)
        
        # إنشاء إحصائيات المركبات
        self.إنشاء_إحصائيات_المركبات(مركبات_مختارة, عداد_المركبات)
    
    def إنشاء_إحصائيات_المركبات(self, مركبات_مختارة, عداد_المركبات):
        """إنشاء إحصائيات شاملة للمركبات"""
        إجمالي_المركبات = sum(عداد_المركبات.values())
        عدد_المركبات_الفريدة = len(عداد_المركبات)
        عدد_المركبات_المختارة = len(مركبات_مختارة)
        
        # حساب متوسط المقاييس
        متوسط_pmi = sum(م['pmi'] for م in مركبات_مختارة) / عدد_المركبات_المختارة if مركبات_مختارة else 0
        متوسط_t_score = sum(م['t_score'] for م in مركبات_مختارة) / عدد_المركبات_المختارة if مركبات_مختارة else 0
        متوسط_ll = sum(م['log_likelihood'] for م in مركبات_مختارة) / عدد_المركبات_المختارة if مركبات_مختارة else 0
        
        # توزيع التصنيفات
        توزيع_التصنيفات = Counter(م['تصنيف'] for م in مركبات_مختارة)
        
        تقرير = f"""=== إحصائيات المركبات الشاملة ===

إحصائيات عامة:
- إجمالي عدد المركبات: {إجمالي_المركبات:,}
- عدد المركبات الفريدة: {عدد_المركبات_الفريدة:,}
- عدد المركبات المختارة: {عدد_المركبات_المختارة:,}
- نسبة المركبات المختارة: {(عدد_المركبات_المختارة/عدد_المركبات_الفريدة*100):.1f}%

متوسط المقاييس للمركبات المختارة:
- متوسط PMI: {متوسط_pmi:.3f}
- متوسط T-score: {متوسط_t_score:.3f}
- متوسط Log-likelihood: {متوسط_ll:.3f}

توزيع التصنيفات:
"""
        
        for تصنيف, عدد in توزيع_التصنيفات.most_common():
            نسبة = (عدد / عدد_المركبات_المختارة) * 100
            تقرير += f"- {تصنيف}: {عدد} مركب ({نسبة:.1f}%)\n"
        
        تقرير += "\nأقوى 10 مركبات (حسب PMI):\n"
        for مرتبة, مركب in enumerate(مركبات_مختارة[:10], 1):
            تقرير += f"{مرتبة}. {مركب['مركب']} (PMI: {مركب['pmi']}, تصنيف: {مركب['تصنيف']})\n"
        
        self.حفظ_في_ملف("إحصائيات_المركبات", تقرير)
    
    def حفظ_في_ملف(self, اسم_الملف, محتوى):
        """حفظ المحتوى في ملف txt"""
        if not os.path.exists(self.مجلد_النتائج):
            os.makedirs(self.مجلد_النتائج)
        
        مسار_الملف = os.path.join(self.مجلد_النتائج, f"{اسم_الملف}.txt")
        with open(مسار_الملف, 'w', encoding='utf-8') as ملف:
            ملف.write(محتوى)
        print(f"تم حفظ: {مسار_الملف}")
