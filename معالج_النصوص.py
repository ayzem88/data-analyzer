# -*- coding: utf-8 -*-
"""
معالج النصوص - تنظيف ومعالجة النصوص العربية
يحفظ النتائج في ملفات txt
"""

import re
import os
from collections import Counter

class معالج_النصوص:
    def __init__(self, مجلد_المدونة="المدونة"):
        self.مجلد_المدونة = مجلد_المدونة
        self.مجلد_النتائج = "نتائج_التحليل"
        
    def إزالة_الرموز_والأرقام(self, نص):
        """إزالة جميع الرموز والأرقام والكلمات غير العربية"""
        # إزالة جميع الرموز والأرقام والحروف غير العربية
        رموز_للإزالة = r'[!"\\#\$%\&\'\(\)\*\+\,\-\.\/0123456789:;<=>\?@\[\\\]\^_`{|}~ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz٠١٢٣٤٥٦٧٨٩۰۱۲۳٤٥٦٧۸۹؛؟،ـ]'
        نص_مُنظف = re.sub(رموز_للإزالة, '', نص)
        return نص_مُنظف
    
    def إزالة_التشكيل(self, نص):
        """إزالة الحركات والتشكيل من النص العربي"""
        تشكيل = re.compile(r'[\u064B-\u065F\u0617-\u061A]')
        return تشكيل.sub('', نص)
    
    def إزالة_الأسطر_الفارغة(self, نص):
        """إزالة الأسطر الفارغة والفراغات الزائدة"""
        أسطر = نص.split('\n')
        أسطر_غير_فارغة = [سطر.strip() for سطر in أسطر if سطر.strip()]
        return '\n'.join(أسطر_غير_فارغة)
    
    def تنظيف_الفراغات(self, نص):
        """تنظيف الفراغات الزائدة"""
        return re.sub(r'\s+', ' ', نص).strip()
    
    def معالجة_ملف_واحد(self, مسار_الملف):
        """معالجة ملف نصي واحد"""
        try:
            # قراءة الملف مع محاولة ترميزات مختلفة
            نص_أصلي = ""
            for ترميز in ['utf-8', 'cp1256', 'latin-1', 'iso-8859-1']:
                try:
                    with open(مسار_الملف, 'r', encoding=ترميز) as ملف:
                        نص_أصلي = ملف.read()
                    break
                except UnicodeDecodeError:
                    continue
            
            if not نص_أصلي:
                print(f"تحذير: تعذر قراءة الملف {مسار_الملف}")
                return "", 0, 0
            
            # تطبيق المعالجة
            نص_مُنظف = نص_أصلي
            نص_مُنظف = self.إزالة_الرموز_والأرقام(نص_مُنظف)
            نص_مُنظف = self.إزالة_التشكيل(نص_مُنظف)
            نص_مُنظف = self.إزالة_الأسطر_الفارغة(نص_مُنظف)
            نص_مُنظف = self.تنظيف_الفراغات(نص_مُنظف)
            
            return نص_مُنظف, len(نص_أصلي), len(نص_مُنظف)
            
        except Exception as خطأ:
            print(f"خطأ في معالجة الملف {مسار_الملف}: {خطأ}")
            return "", 0, 0
    
    def معالجة_جميع_الملفات(self):
        """معالجة جميع ملفات txt في مجلد المدونة"""
        print("بدء معالجة النصوص...")
        
        جميع_النصوص = []
        إحصائيات_الملفات = []
        
        # البحث عن ملفات txt
        for اسم_ملف in os.listdir(self.مجلد_المدونة):
            if اسم_ملف.lower().endswith('.txt'):
                مسار_الملف = os.path.join(self.مجلد_المدونة, اسم_ملف)
                نص_مُنظف, طول_أصلي, طول_مُنظف = self.معالجة_ملف_واحد(مسار_الملف)
                
                if نص_مُنظف:
                    جميع_النصوص.append(نص_مُنظف)
                    إحصائيات_الملفات.append({
                        'اسم_الملف': اسم_ملف,
                        'الطول_الأصلي': طول_أصلي,
                        'الطول_المُنظف': طول_مُنظف,
                        'النسبة_المحذوفة': round((طول_أصلي - طول_مُنظف) / طول_أصلي * 100, 2)
                    })
        
        # حفظ النصوص المُعالجة
        نص_كامل = '\n\n'.join(جميع_النصوص)
        self.حفظ_في_ملف("نصوص_مُعالجة", نص_كامل)
        
        # حفظ تقرير التنظيف
        تقرير_التنظيف = self.إنشاء_تقرير_التنظيف(إحصائيات_الملفات)
        self.حفظ_في_ملف("تقرير_التنظيف", تقرير_التنظيف)
        
        print(f"تم معالجة {len(إحصائيات_الملفات)} ملف")
        return جميع_النصوص
    
    def إنشاء_تقرير_التنظيف(self, إحصائيات_الملفات):
        """إنشاء تقرير تفصيلي عن عملية التنظيف"""
        تقرير = "=== تقرير تنظيف النصوص ===\n\n"
        
        إجمالي_أصلي = sum(ملف['الطول_الأصلي'] for ملف in إحصائيات_الملفات)
        إجمالي_مُنظف = sum(ملف['الطول_المُنظف'] for ملف in إحصائيات_الملفات)
        
        تقرير += f"إجمالي عدد الملفات: {len(إحصائيات_الملفات)}\n"
        تقرير += f"إجمالي الطول الأصلي: {إجمالي_أصلي:,} حرف\n"
        تقرير += f"إجمالي الطول المُنظف: {إجمالي_مُنظف:,} حرف\n"
        تقرير += f"إجمالي المحذوف: {إجمالي_أصلي - إجمالي_مُنظف:,} حرف\n"
        تقرير += f"نسبة التنظيف: {round((إجمالي_أصلي - إجمالي_مُنظف) / إجمالي_أصلي * 100, 2)}%\n\n"
        
        تقرير += "=== تفاصيل كل ملف ===\n"
        for ملف in إحصائيات_الملفات:
            تقرير += f"الملف: {ملف['اسم_الملف']}\n"
            تقرير += f"  الطول الأصلي: {ملف['الطول_الأصلي']:,} حرف\n"
            تقرير += f"  الطول المُنظف: {ملف['الطول_المُنظف']:,} حرف\n"
            تقرير += f"  النسبة المحذوفة: {ملف['النسبة_المحذوفة']}%\n\n"
        
        return تقرير
    
    def حفظ_في_ملف(self, اسم_الملف, محتوى):
        """حفظ المحتوى في ملف txt"""
        if not os.path.exists(self.مجلد_النتائج):
            os.makedirs(self.مجلد_النتائج)
        
        مسار_الملف = os.path.join(self.مجلد_النتائج, f"{اسم_الملف}.txt")
        with open(مسار_الملف, 'w', encoding='utf-8') as ملف:
            ملف.write(محتوى)
        print(f"تم حفظ: {مسار_الملف}")
